<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heady AI</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e17; color: #e2e8f0; height: 100vh;
      display: flex; flex-direction: column;
    }
    .header {
      display: flex; align-items: center; gap: 8px;
      padding: 12px 16px; border-bottom: 1px solid #1e293b;
      background: #111827;
    }
    .header .orb {
      width: 28px; height: 28px; border-radius: 50%;
      background: linear-gradient(135deg, #22d3ee, #34d399);
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
    }
    .header h1 { font-size: 14px; font-weight: 600; flex: 1; }
    .header .status {
      width: 8px; height: 8px; border-radius: 50%;
      background: #64748b;
    }
    .header .status.online { background: #34d399; }
    .messages {
      flex: 1; overflow-y: auto; padding: 16px;
      display: flex; flex-direction: column; gap: 12px;
    }
    .msg { padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.5; max-width: 90%; }
    .msg.user { background: #1e293b; align-self: flex-end; border-bottom-right-radius: 4px; }
    .msg.assistant { background: #111827; border: 1px solid #1e293b; align-self: flex-start; border-bottom-left-radius: 4px; }
    .msg.system { background: transparent; color: #64748b; font-size: 11px; text-align: center; align-self: center; }
    .chips { display: flex; gap: 6px; flex-wrap: wrap; padding: 8px 16px; }
    .chip {
      background: #1e293b; border: 1px solid #334155; border-radius: 999px;
      padding: 4px 12px; font-size: 11px; color: #e2e8f0; cursor: pointer;
      transition: border-color 0.2s;
    }
    .chip:hover { border-color: #22d3ee; }
    .input-row {
      display: flex; align-items: center; gap: 8px;
      padding: 12px 16px; border-top: 1px solid #1e293b; background: #111827;
    }
    .input-row input {
      flex: 1; background: #0a0e17; border: 1px solid #1e293b; border-radius: 20px;
      padding: 8px 16px; color: #e2e8f0; font-size: 13px; outline: none;
    }
    .input-row input:focus { border-color: #22d3ee; }
    .input-row button {
      background: #22d3ee; border: none; border-radius: 50%; width: 32px; height: 32px;
      color: #0a0e17; font-size: 16px; cursor: pointer; display: flex;
      align-items: center; justify-content: center;
    }
    .input-row button:disabled { opacity: 0.4; cursor: not-allowed; }
    .loading { display: inline-block; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }
  </style>
</head>
<body>
  <div class="header">
    <div class="orb">H</div>
    <h1>Heady AI</h1>
    <div class="status" id="status"></div>
  </div>

  <div class="messages" id="messages">
    <div class="msg system">Ask me anything about this page or any topic.</div>
  </div>

  <div class="chips" id="chips">
    <span class="chip" data-q="Summarize this page">Summarize</span>
    <span class="chip" data-q="Explain this simply">Explain</span>
    <span class="chip" data-q="Find key points">Key points</span>
    <span class="chip" data-q="Compare with alternatives">Compare</span>
  </div>

  <div class="input-row">
    <input type="text" id="input" placeholder="Ask Heady..." autocomplete="off" />
    <button id="send" title="Send">&#9654;</button>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');

    // Health check
    chrome.runtime.sendMessage({ type: 'HEALTH_CHECK' }, (res) => {
      statusEl.classList.toggle('online', res?.ok);
    });

    // Listen for queries from background (context menu, shortcuts)
    chrome.runtime.onMessage.addListener((msg) => {
      if (msg.type === 'SIDE_PANEL_QUERY') {
        inputEl.value = msg.query;
        sendMessage();
      }
    });

    // Chips
    document.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', () => {
        inputEl.value = chip.dataset.q;
        sendMessage();
      });
    });

    // Send
    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    async function sendMessage() {
      const query = inputEl.value.trim();
      if (!query) return;

      addMessage(query, 'user');
      inputEl.value = '';
      sendBtn.disabled = true;

      // Get page context
      const pageContent = await new Promise((resolve) => {
        chrome.runtime.sendMessage({ type: 'GET_PAGE_CONTENT' }, resolve);
      });

      const loadingEl = addMessage('<span class="loading">Thinking...</span>', 'assistant', true);

      chrome.runtime.sendMessage(
        { type: 'CHAT', query, context: pageContent?.text || '' },
        (res) => {
          loadingEl.remove();
          if (res?.ok) {
            addMessage(res.reply, 'assistant');
          } else {
            addMessage(`Connection issue: ${res?.error || 'unknown'}. Is heady-manager running?`, 'system');
          }
          sendBtn.disabled = false;
        }
      );
    }

    function addMessage(text, role, isHtml = false) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      if (isHtml) div.innerHTML = text;
      else div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return div;
    }
  </script>
</body>
</html>
