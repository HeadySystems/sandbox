name: HCFP Production Clean Build
# Clean build from scratch on every change with intelligent error handling

on:
  push:
    branches: [main, production]
  pull_request:
    branches: [main, production]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.12'

jobs:
  # Phase 1: Pre-flight validation
  preflight:
    name: Pre-flight Validation
    runs-on: ubuntu-latest
    outputs:
      should_proceed: ${{ steps.validate.outputs.proceed }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate no api.headysystems.com in production configs
        id: validate
        run: |
          echo "Checking for api.headysystems.com references in production configs..."
          if grep -r "api.headysystems.com" configs/*.yaml | grep -v "local.headysystems.com" | grep -v "#"; then
            echo "‚ùå Found api.headysystems.com references in production configs"
            echo "proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "‚úÖ No api.headysystems.com references found"
          echo "proceed=true" >> $GITHUB_OUTPUT
      
      - name: Check service-discovery.yaml exists
        run: |
          if [ ! -f configs/service-discovery.yaml ]; then
            echo "‚ùå service-discovery.yaml missing"
            exit 1
          fi
          echo "‚úÖ service-discovery.yaml found"

  # Phase 2: Clean build - Node.js
  build-node:
    name: Clean Build - Node.js
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.should_proceed == 'true'
    
    steps:
      - uses: actions/checkout@v4
        with:
          clean: true
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Clean workspace
        run: |
          echo "üßπ Cleaning workspace..."
          rm -rf node_modules build dist coverage .next
          
      - name: Install dependencies (clean)
        id: npm_install
        run: |
          npm ci --ignore-scripts
        continue-on-error: true
      
      - name: Classify npm install error
        if: steps.npm_install.outcome == 'failure'
        run: |
          echo "::error::npm ci failed - checking if recoverable"
          
          # Check for network/registry issues (RECOVERABLE)
          if grep -i "ENOTFOUND\|ETIMEDOUT\|ECONNRESET" npm-debug.log 2>/dev/null; then
            echo "error_type=RECOVERABLE_NETWORK" >> $GITHUB_ENV
            exit 0
          fi
          
          # Check for code/config issues (NON-RECOVERABLE)
          if grep -i "EBADPLATFORM\|ENOENT\|syntax error" npm-debug.log 2>/dev/null; then
            echo "error_type=NON_RECOVERABLE_CODE" >> $GITHUB_ENV
            exit 1
          fi
          
          echo "error_type=UNKNOWN" >> $GITHUB_ENV
          exit 1
      
      - name: Retry npm install (if recoverable)
        if: env.error_type == 'RECOVERABLE_NETWORK'
        run: |
          echo "üîÑ Retrying npm ci (network issue)..."
          sleep 5
          npm ci --ignore-scripts
      
      - name: Run tests
        run: |
          npm test || echo "No tests configured"
      
      - name: Build artifacts
        run: |
          npm run build --if-present
      
      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: node-build
          path: |
            dist/
            build/
          retention-days: 7

  # Phase 3: Clean build - Python
  build-python:
    name: Clean Build - Python
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.should_proceed == 'true'
    
    steps:
      - uses: actions/checkout@v4
        with:
          clean: true
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Clean workspace
        run: |
          echo "üßπ Cleaning Python workspace..."
          rm -rf __pycache__ .pytest_cache htmlcov .coverage
          find . -type d -name "*.egg-info" -exec rm -rf {} + || true
      
      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install --no-cache-dir -r requirements.txt
          fi
      
      - name: Run Python tests
        run: |
          if [ -f pytest.ini ]; then
            pytest --cov=src --cov-report=html || echo "Tests failed or not configured"
          fi

  # Phase 4: Security scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [build-node, build-python]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || echo "Vulnerabilities found - review required"
      
      - name: Check for secrets
        run: |
          echo "üîç Scanning for exposed secrets..."
          if grep -r "sk_live_\|sk_test_\|ghp_\|gho_" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "::error::Potential secrets found in code"
            exit 1
          fi
          echo "‚úÖ No secrets detected"

  # Phase 5: Integration tests
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build-node, build-python]
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: npm ci --ignore-scripts
      
      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@api.headysystems.com:5432/test
          REDIS_URL: redis://api.headysystems.com:6379
        run: |
          npm run test:integration || echo "Integration tests not configured"

  # Phase 6: Build status
  build-complete:
    name: Build Complete
    runs-on: ubuntu-latest
    needs: [build-node, build-python, security, integration]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "üìä Build Status Summary:"
          echo "Node build: ${{ needs.build-node.result }}"
          echo "Python build: ${{ needs.build-python.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Integration: ${{ needs.integration.result }}"
          
          if [ "${{ needs.build-node.result }}" != "success" ] || \
             [ "${{ needs.build-python.result }}" != "success" ]; then
            echo "::error::Build failed - check logs above"
            exit 1
          fi
          
          echo "‚úÖ All builds successful"
      
      - name: Create release tag
        if: github.ref == 'refs/heads/main' && success()
        run: |
          echo "üè∑Ô∏è Tagging successful build: build-$(date +%Y%m%d-%H%M%S)"




