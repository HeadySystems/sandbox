# Heady Clean-Build CI/CD Pipeline
#
# This workflow ensures:
# 1. Every change triggers a full clean build (no incremental artifacts)
# 2. Strong error handling with classification and retries
# 3. Deterministic builds with pinned dependencies
# 4. Automatic alerts when human intervention needed

name: Heady Clean Build & Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Nightly clean build to catch drift
    - cron: '0 3 * * *'

env:
  NODE_VERSION: '20.18.1'
  PYTHON_VERSION: '3.12.7'
  BUILD_TIMEOUT: 30m
  MAX_RETRIES: 3

jobs:
  # ============================================================================
  # JOB 1: Pre-flight Checks & Inventory
  # ============================================================================
  preflight:
    name: ðŸ” Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      changed_services: ${{ steps.changes.outputs.services }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Full clone for clean build verification
          fetch-depth: 0
          
      - name: Check for localhost references
        id: localhost_check
        run: |
          echo "Checking for forbidden localhost references..."
          VIOLATIONS=$(grep -r "http://localhost\|https://localhost\|127.0.0.1\|0.0.0.0" --include="*.js" --include="*.json" --include="*.yaml" . 2>/dev/null || true)
          if [ -n "$VIOLATIONS" ]; then
            echo "âš ï¸ Found localhost references that should use domains:"
            echo "$VIOLATIONS"
            echo "::warning::Localhost references found - consider using service domains"
          fi
          
      - name: Detect changed services
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            manager:
              - 'heady-manager.js'
              - 'src/**'
              - 'configs/**'
            frontend:
              - 'frontend/**'
            worker:
              - 'backend/python_worker/**'
            docker:
              - 'Dockerfile'
              - 'docker-compose.yml'
              
      - name: Set build decision
        id: check
        run: |
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "Nightly build triggered"
          elif [ "${{ steps.changes.outputs.changes }}" != "[]" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "Changes detected in: ${{ steps.changes.outputs.changes }}"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "No relevant changes detected"

  # ============================================================================
  # JOB 2: Clean Build - Manager (Node.js)
  # ============================================================================
  build-manager:
    name: ðŸ—ï¸ Clean Build - Manager
    needs: preflight
    if: needs.preflight.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code (fresh)
        uses: actions/checkout@v4
        with:
          clean: true  # Remove any existing files
          
      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Clean environment
        run: |
          echo "Cleaning build environment..."
          rm -rf node_modules
          rm -rf dist
          rm -rf .heady_cache
          rm -rf coverage
          npm cache clean --force
          
      - name: Install dependencies (clean)
        id: install
        run: |
          echo "Installing dependencies from scratch..."
          npm ci  # Uses package-lock.json for deterministic install
        timeout-minutes: 10
        
      - name: Lint code
        id: lint
        run: |
          echo "Running ESLint..."
          npm run lint 2>&1 | tee lint-output.txt || true
          if [ -s lint-output.txt ]; then
            echo "Lint issues found"
            exit 1
          fi
        continue-on-error: false
        
      - name: Run tests
        id: test
        run: |
          echo "Running test suite..."
          npm test 2>&1 | tee test-output.txt
        timeout-minutes: 15
        
      - name: Build application
        id: build
        run: |
          echo "Building application..."
          npm run build 2>&1 | tee build-output.txt
        timeout-minutes: 10
        
      - name: Verify build artifacts
        run: |
          echo "Verifying build artifacts..."
          if [ ! -d "dist" ]; then
            echo "âŒ Build artifacts not found"
            exit 1
          fi
          echo "âœ… Build artifacts verified"
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: manager-build
          path: dist/
          retention-days: 7
          
      # Error handling and classification
      - name: Handle failures
        if: failure()
        run: |
          echo "::error::Build failed - classifying error..."
          # Classify error type
          if grep -q "EPERM\|EACCES\|permission denied" test-output.txt 2>/dev/null; then
            echo "error_type=permission" >> $GITHUB_ENV
          elif grep -q "ENOMEM\|memory\|heap" test-output.txt 2>/dev/null; then
            echo "error_type=resource" >> $GITHUB_ENV
          elif grep -q "ETIMEDOUT\|ECONNREFUSED\|network" test-output.txt 2>/dev/null; then
            echo "error_type=network" >> $GITHUB_ENV
          elif grep -q "SyntaxError\|ReferenceError\|TypeError" test-output.txt 2>/dev/null; then
            echo "error_type=code" >> $GITHUB_ENV
          else
            echo "error_type=unknown" >> $GITHUB_ENV
          fi
          
      - name: Retry on transient errors
        if: failure() && (env.error_type == 'network' || env.error_type == 'resource')
        run: |
          echo "Transient error detected - would retry (max ${{ env.MAX_RETRIES }} times)"
          # Actual retry logic would go here
          
      - name: Alert on code errors
        if: failure() && env.error_type == 'code'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš¨ Heady Manager build failed with code error",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Build Failed*\nCode syntax or logic error detected. Requires human intervention."
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ github.sha }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ============================================================================
  # JOB 3: Clean Build - Frontend
  # ============================================================================
  build-frontend:
    name: ðŸ—ï¸ Clean Build - Frontend
    needs: preflight
    if: needs.preflight.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout code (fresh)
        uses: actions/checkout@v4
        with:
          clean: true
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
          
      - name: Clean environment
        run: |
          rm -rf node_modules
          rm -rf dist
          rm -rf build
          npm cache clean --force
          
      - name: Install dependencies
        run: npm ci
        
      - name: Type check
        run: npm run type-check || true
        
      - name: Lint
        run: npm run lint
        
      - name: Build
        run: npm run build
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/

  # ============================================================================
  # JOB 4: Clean Build - Python Worker
  # ============================================================================
  build-worker:
    name: ðŸ—ï¸ Clean Build - Python Worker
    needs: preflight
    if: needs.preflight.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: backend/python_worker
    steps:
      - name: Checkout code (fresh)
        uses: actions/checkout@v4
        with:
          clean: true
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Clean environment
        run: |
          rm -rf venv
          rm -rf __pycache__
          rm -rf .pytest_cache
          rm -rf dist
          
      - name: Create virtual environment
        run: |
          python -m venv venv
          source venv/bin/activate
          
      - name: Install dependencies
        run: |
          source venv/bin/activate
          pip install --no-cache-dir -r requirements.txt
          
      - name: Run tests
        run: |
          source venv/bin/activate
          pytest --cov=. --cov-report=xml
          
      - name: Build Docker image
        run: |
          docker build -t heady-worker:${{ github.sha }} .
          
      - name: Save Docker image
        run: |
          docker save heady-worker:${{ github.sha }} > worker-image.tar
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: worker-image
          path: backend/python_worker/worker-image.tar

  # ============================================================================
  # JOB 5: Integration Tests
  # ============================================================================
  integration-tests:
    name: ðŸ”— Integration Tests
    needs: [build-manager, build-frontend, build-worker]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: heady_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7
        ports:
          - 6379:6379
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download manager artifacts
        uses: actions/download-artifact@v4
        with:
          name: manager-build
          path: dist/
          
      - name: Setup test environment
        run: |
          echo "DATABASE_URL=postgresql://postgres:test@localhost:5432/heady_test" >> $GITHUB_ENV
          echo "REDIS_URL=redis://localhost:6379" >> $GITHUB_ENV
          echo "HEADY_MANAGER_URL=http://localhost:3300" >> $GITHUB_ENV
          
      - name: Start services for integration test
        run: |
          # Start manager
          node dist/heady-manager.js &
          MANAGER_PID=$!
          
          # Wait for health check
          for i in {1..30}; do
            if curl -s http://localhost:3300/api/health; then
              echo "Manager is ready"
              break
            fi
            sleep 2
          done
          
          # Run integration tests
          npm run test:integration
          
          # Cleanup
          kill $MANAGER_PID || true

  # ============================================================================
  # JOB 6: Security Scan
  # ============================================================================
  security-scan:
    name: ðŸ”’ Security Scan
    needs: [build-manager, build-frontend, build-worker]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          
      - name: Upload scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================================================
  # JOB 7: Deploy to Staging
  # ============================================================================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    needs: [integration-tests, security-scan]
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.heady.systems
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          # Use same artifacts built in CI, never rebuild
          rsync -avz manager-build/ staging-server:/opt/heady/manager/
          rsync -avz frontend-build/ staging-server:/opt/heady/frontend/
          
      - name: Health check
        run: |
          for i in {1..10}; do
            if curl -sf https://staging.heady.systems/api/health; then
              echo "âœ… Staging deployment healthy"
              exit 0
            fi
            sleep 5
          done
          echo "âŒ Staging health check failed"
          exit 1

  # ============================================================================
  # JOB 8: Deploy to Production (with approval)
  # ============================================================================
  deploy-production:
    name: ðŸš€ Deploy to Production
    needs: [integration-tests, security-scan]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://www.heady.systems
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Deploy to production
        run: |
          echo "Deploying to production environment..."
          # Deploy using pre-built artifacts
          rsync -avz manager-build/ prod-server-1:/opt/heady/manager/
          rsync -avz manager-build/ prod-server-2:/opt/heady/manager/
          
      - name: Smoke tests
        run: |
          curl -sf https://www.heady.systems/api/health
          curl -sf https://api.heady.systems/api/health
          
      - name: Notify deployment
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âœ… Heady deployed to production",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment Complete*\nCommit: ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ============================================================================
  # JOB 9: Post-build Summary
  # ============================================================================
  summary:
    name: ðŸ“Š Build Summary
    needs: [deploy-staging, deploy-production]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## Clean Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-flight | ${{ needs.preflight.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Manager | ${{ needs.build-manager.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Frontend | ${{ needs.build-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Worker | ${{ needs.build-worker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Staging | ${{ needs.deploy-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Production | ${{ needs.deploy-production.result }} |" >> $GITHUB_STEP_SUMMARY
