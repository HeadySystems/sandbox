<# HEADY_BRAND:BEGIN
<# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
<# â•‘  â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—                     â•‘
<# â•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•                     â•‘
<# â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•                      â•‘
<# â•‘  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•                       â•‘
<# â•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘                        â•‘
<# â•‘  â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•    â•šâ•â•                        â•‘
<# â•‘                                                                  â•‘
<# â•‘  âˆ SACRED GEOMETRY âˆ  Organic Systems Â· Breathing Interfaces    â•‘
<# â•‘  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â•‘
<# â•‘  FILE: scripts/auto-deploy-fixed.ps1                                                    â•‘
<# â•‘  LAYER: automation                                                  â•‘
<# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
<# HEADY_BRAND:END
#>
# HEADY_BRAND:BEGIN
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—                     â•‘
# â•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•                     â•‘
# â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•                      â•‘
# â•‘  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•                       â•‘
# â•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘                        â•‘
# â•‘  â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•    â•šâ•â•                        â•‘
# â•‘                                                                  â•‘
# â•‘  âˆ SACRED GEOMETRY âˆ  Organic Systems Â· Breathing Interfaces    â•‘
# â•‘  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â•‘
# â•‘  FILE: scripts/auto-deploy-fixed.ps1                              â•‘
# â•‘  LAYER: automation                                                  â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HEADY_BRAND:END

# HeadyWeb Auto-Deploy Script - Fixed Version
# Deploy HeadyWeb with dual-engine architecture to production

param(
    [Parameter(Mandatory=$false)]
    [string]$Version = "1.0.0-beta",
    
    [Parameter(Mandatory=$false)]
    [string]$Environment = "production",
    
    [Parameter(Mandatory=$false)]
    [switch]$SkipTests,
    
    [Parameter(Mandatory=$false)]
    [switch]$Force
)

Write-Host "ğŸš€ HeadyWeb Auto-Deploy Starting..." -ForegroundColor Cyan
Write-Host "Version: $Version" -ForegroundColor Green
Write-Host "Environment: $Environment" -ForegroundColor Green

# Validate environment
if (-not (Test-Path "apps/headyweb")) {
    Write-Error "âŒ HeadyWeb directory not found. Please run from project root."
    exit 1
}

# Check if HeadyWeb is built
if (-not (Test-Path "apps/headyweb/dist")) {
    Write-Host "ğŸ”¨ Building HeadyWeb..." -ForegroundColor Yellow
    
    try {
        Set-Location "apps/headyweb"
        npm run build
        if ($LASTEXITCODE -ne 0) {
            throw "Build failed"
        }
        Write-Host "âœ… Build completed" -ForegroundColor Green
    } catch {
        Write-Error "âŒ Build failed: $_"
        exit 1
    } finally {
        Set-Location $PSScriptRoot
    }
}

# Create deployment package
Write-Host "ğŸ“¦ Creating deployment package..." -ForegroundColor Yellow

$deployDir = "deployments/headyweb-$Version"
if (Test-Path $deployDir) {
    Remove-Item -Recurse -Force $deployDir
}
New-Item -ItemType Directory -Path $deployDir -Force | Out-Null

# Copy built files
Copy-Item -Recurse "apps/headyweb/dist\*" "$deployDir/" -Force
Copy-Item "apps/headyweb/package.json" "$deployDir/" -Force
Copy-Item "apps/headyweb/index.html" "$deployDir/" -Force

# Create deployment metadata
$deployMetadata = @{
    version = $Version
    environment = $Environment
    timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
    features = @(
        "dual-engine",
        "quantum-acceleration", 
        "ai-enhanced-rendering",
        "sacred-geometry-ui",
        "comet-experimental",
        "chromium-beta"
    )
    engines = @{
        comet = "beta-experimental"
        chromium = "beta-latest"
    }
    buildInfo = @{
        nodeVersion = (node --version)
        platform = $PSVersionTable.PSVersion.Platform
        architecture = $env:PROCESSOR_ARCHITECTURE
    }
}

$deployMetadata | ConvertTo-Json -Depth 4 | Out-File "$deployDir/deploy-metadata.json" -Encoding UTF8

# Create deployment script
$deployScript = @"
# HeadyWeb Deployment Script
Write-Host "ğŸŒŸ Starting HeadyWeb v$deployMetadata.version"
Write-Host "Features: $($deployMetadata.features -join ', ')"
Write-Host "Engines: Comet $($deployMetadata.engines.comet) + Chromium $($deployMetadata.engines.chromium)"

# Start HeadyWeb
if (Test-Path "dist/main.js") {
    Write-Host "ğŸš€ Launching HeadyWeb..."
    node dist/main.js
} else {
    Write-Warning "âš ï¸ Main executable not found"
}
"@

$deployScript | Out-File "$deployDir/deploy.sh" -Encoding UTF8

# Create README for deployment
$deployReadme = @"
# HeadyWeb Deployment

## Version: $Version
## Environment: $Environment
## Deployed: $(Get-Date)

### Features
- Dual-engine architecture (Comet + Chromium)
- Quantum computing acceleration
- AI-enhanced rendering
- Sacred Geometry UI
- WebGPU and experimental APIs

### Quick Start
\`\`\`bash
./deploy.sh
\`\`\`

### Architecture
- **Comet Engine**: Experimental features, WebGPU, quantum acceleration
- **Chromium Beta**: Stable foundation, extensions, developer tools
- **Engine Router**: Intelligent switching based on content analysis
- **Sacred Geometry UI**: Organic, breathing interfaces

### Configuration
- Edit \`deploy-metadata.json\` for custom settings
- Environment variables in \`.env\` file
- Engine preferences in \`config/engine-config.json\`
"@

$deployReadme | Out-File "$deployDir/README.md" -Encoding UTF8

# Create systemd service (Linux)
if ($IsLinux) {
    $systemdService = @"
[Unit]
Description=HeadyWeb Browser
After=network.target

[Service]
Type=simple
User=heady
WorkingDirectory=$deployDir
ExecStart=/usr/bin/node $deployDir/main.js
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
"@
    
    $systemdService | Out-File "$deployDir/headyweb.service" -Encoding UTF8

# Create Windows service
if ($IsWindows) {
    $nssmPath = "nssm.exe"
    if (Get-Command $nssmPath -ErrorAction SilentlyContinue) {
        Write-Host "ğŸ”§ Creating Windows service..." -ForegroundColor Yellow
        
        $serviceArgs = @(
            "install", "HeadyWeb", "HeadyWeb Browser",
            "$deployDir\main.js",
            "node", "$deployDir\main.js"
        )
        
        & $nssmPath $serviceArgs
        Write-Host "âœ… Windows service created" -ForegroundColor Green
    }
}

# Health check
Write-Host "ğŸ” Performing health check..." -ForegroundColor Yellow

$healthChecks = @(
    { Name = "Build Directory", Check = { Test-Path "$deployDir" } }
    { Name = "Main Executable", Check = { Test-Path "$deployDir/main.js" } }
    { Name = "Package Config", Check = { Test-Path "$deployDir/package.json" } }
    { Name = "Index HTML", Check = { Test-Path "$deployDir/index.html" } }
    { Name = "Metadata", Check = { Test-Path "$deployDir/deploy-metadata.json" } }
)

$allHealthy = $true
foreach ($check in $healthChecks) {
    if ($check.Check.Invoke()) {
        Write-Host "âœ… $($check.Name)" -ForegroundColor Green
    } else {
        Write-Host "âŒ $($check.Name)" -ForegroundColor Red
        $allHealthy = $false
    }
}

if (-not $allHealthy) {
    Write-Error "âŒ Health check failed"
    exit 1
}

# Create deployment archive
Write-Host "ğŸ“¦ Creating deployment archive..." -ForegroundColor Yellow

$archiveName = "headyweb-$Version-$Environment.zip"
$archivePath = "deployments/$archiveName"

if (Test-Path $archivePath) {
    Remove-Item $archivePath -Force
}

Compress-Archive -Path $deployDir -DestinationPath $archivePath

# Calculate checksum
$checksum = (Get-FileHash $archivePath -Algorithm SHA256).Hash
$checksum | Out-File "$archivePath.sha256" -Encoding UTF8

Write-Host "âœ… Deployment package created: $archiveName" -ForegroundColor Green
Write-Host "ğŸ” Checksum: $checksum" -ForegroundColor Cyan

# Update deployment registry
Write-Host "ğŸ“‹ Updating deployment registry..." -ForegroundColor Yellow

$registryPath = "deployments/latest.json"
$registryEntry = @{
    application = "HeadyWeb"
    version = $Version
    environment = $Environment
    timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
    archive = $archiveName
    checksum = $checksum
    size = (Get-Item $archivePath).Length
    metadata = $deployMetadata
}

$registryEntry | ConvertTo-Json -Depth 4 | Out-File $registryPath -Encoding UTF8

# Success
Write-Host "ğŸ‰ Auto-deploy completed successfully!" -ForegroundColor Green
Write-Host "ğŸ“¦ Package: $archiveName" -ForegroundColor Cyan
Write-Host "ğŸ“‚ Registry: $registryPath" -ForegroundColor Cyan
Write-Host "ğŸ” Checksum: $checksum" -ForegroundColor Cyan

Write-Host "`nğŸš€ Ready to deploy HeadyWeb with:" -ForegroundColor Yellow
Write-Host "  â€¢ Dual-engine architecture" -ForegroundColor White
Write-Host "  â€¢ Quantum computing acceleration" -ForegroundColor White  
Write-Host "  â€¢ AI-enhanced rendering" -ForegroundColor White
Write-Host "  â€¢ Sacred Geometry UI" -ForegroundColor White
Write-Host "  â€¢ WebGPU and experimental APIs" -ForegroundColor White

exit 0
