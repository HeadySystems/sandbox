# Heady Service Discovery & Domain Architecture
# Replaces all localhost references with proper internal domains
# Root Domain: heady.internal

root_domain: heady.internal
environment: dev  # dev, staging, prod
region: local

# Core Heady Services - Primary Nodes
services:
  # Manager/Orchestrator
  manager:
    host: manager.dev.local.heady.internal
    port: 3300
    protocol: http
    aliases:
      - api.dev.local.heady.internal
      - orchestrator.dev.local.heady.internal
    purpose: Central API and orchestration hub
    security_level: internal
    
  # Database Layer
  postgres:
    host: db-postgres.dev.local.heady.internal
    port: 5432
    protocol: postgresql
    purpose: Primary PostgreSQL with pgvector
    security_level: database
    
  redis:
    host: db-redis.dev.local.heady.internal
    port: 6379
    protocol: redis
    purpose: Caching and session storage
    security_level: database
    
  # AI/ML Services
  ollama:
    host: ai-ollama.dev.local.heady.internal
    port: 11434
    protocol: http
    purpose: Local LLM inference (Llama, Mistral)
    security_level: internal
    
  # RAG/Vector Services
  rag:
    host: ai-rag.dev.local.heady.internal
    port: 8080
    protocol: http
    purpose: Retrieval Augmented Generation service
    security_level: internal
    
  # MCP Gateway
  mcp-gateway:
    host: tools-mcp.dev.local.heady.internal
    port: 3001
    protocol: http
    purpose: Model Context Protocol tool gateway
    security_level: internal
    
  # Web Frontend
  web:
    host: app-web.dev.local.heady.internal
    port: 3000
    protocol: http
    purpose: Heady web dashboard
    security_level: external
    
  # HeadyBuddy Desktop
  buddy:
    host: app-buddy.dev.local.heady.internal
    port: 3301
    protocol: http
    purpose: Desktop overlay assistant
    security_level: internal
    
  # Browser Extension Bridge
  browser-bridge:
    host: bridge-browser.dev.local.heady.internal
    port: 3302
    protocol: http
    purpose: Browser extension communication
    security_level: internal
    
  # Voice I/O Service
  voice:
    host: io-voice.dev.local.heady.internal
    port: 3303
    protocol: http
    purpose: Voice input/output processing
    security_level: internal
    
  # Billing/Telemetry
  billing:
    host: svc-billing.dev.local.heady.internal
    port: 3304
    protocol: http
    purpose: Payment and usage tracking
    security_level: internal
    
  telemetry:
    host: svc-telemetry.dev.local.heady.internal
    port: 3305
    protocol: http
    purpose: Metrics and observability
    security_level: internal

# Admin/Debug Interfaces (Restricted Access)
admin:
  postgres-admin:
    host: admin-postgres.dev.local.heady.internal
    port: 8080
    protocol: http
    purpose: PostgreSQL admin interface
    security_level: admin
    
  redis-admin:
    host: admin-redis.dev.local.heady.internal
    port: 8081
    protocol: http
    purpose: Redis management UI
    security_level: admin
    
  manager-debug:
    host: debug-manager.dev.local.heady.internal
    port: 9090
    protocol: http
    purpose: Debug and profiling endpoints
    security_level: admin

# Service Mesh / Discovery
discovery:
  registry:
    host: discovery.dev.local.heady.internal
    port: 8600
    protocol: http
    purpose: Service registry and health checks
    security_level: internal
    
  dns-internal:
    host: dns.dev.local.heady.internal
    port: 53
    protocol: dns
    purpose: Internal DNS resolution
    security_level: infrastructure

# External Integrations
integrations:
  # Cloud Render deployments
  render-me:
    host: cloud-me.heady.io
    port: 443
    protocol: https
    purpose: HeadyMe cloud deployment
    security_level: external-cloud
    
  render-sys:
    host: cloud-sys.heady.io
    port: 443
    protocol: https
    purpose: HeadySystems cloud deployment
    security_level: external-cloud
    
  render-conn:
    host: cloud-conn.heady.io
    port: 443
    protocol: https
    purpose: HeadyConnection cloud deployment
    security_level: external-cloud

# Reverse Proxy / Gateway Routes
gateway:
  domain: gateway.dev.local.heady.internal
  port: 80
  routes:
    - path: /api
      upstream: manager.dev.local.heady.internal:3300
      
    - path: /app
      upstream: app-web.dev.local.heady.internal:3000
      
    - path: /mcp
      upstream: tools-mcp.dev.local.heady.internal:3001
      
    - path: /ai
      upstream: ai-ollama.dev.local.heady.internal:11434
      
    - path: /db
      upstream: admin-postgres.dev.local.heady.internal:8080
      restrict: admin-only

# mTLS and Security
security:
  mtls:
    enabled: true
    ca_cert: /etc/heady/certs/ca.crt
    cert_dir: /etc/heady/certs/
    
  network_policies:
    default_deny: true
    allow_rules:
      - from: app-web.dev.local.heady.internal
        to: manager.dev.local.heady.internal
        ports: [3300]
        
      - from: bridge-browser.dev.local.heady.internal
        to: manager.dev.local.heady.internal
        ports: [3300]
        
      - from: manager.dev.local.heady.internal
        to: db-postgres.dev.local.heady.internal
        ports: [5432]
        
      - from: manager.dev.local.heady.internal
        to: db-redis.dev.local.heady.internal
        ports: [6379]
        
      - from: tools-mcp.dev.local.heady.internal
        to: ai-ollama.dev.local.heady.internal
        ports: [11434]
        
      - from: ai-rag.dev.local.heady.internal
        to: db-postgres.dev.local.heady.internal
        ports: [5432]

# Localhost Replacement Mappings
# Maps old localhost references to new domain names
localhost_mappings:
  - old: "localhost:3300"
    new: "manager.dev.local.heady.internal:3300"
    service: manager
    
  - old: "127.0.0.1:3300"
    new: "manager.dev.local.heady.internal:3300"
    service: manager
    
  - old: "localhost:5432"
    new: "db-postgres.dev.local.heady.internal:5432"
    service: postgres
    
  - old: "localhost:6379"
    new: "db-redis.dev.local.heady.internal:6379"
    service: redis
    
  - old: "localhost:3000"
    new: "app-web.dev.local.heady.internal:3000"
    service: web
    
  - old: "localhost:3001"
    new: "tools-mcp.dev.local.heady.internal:3001"
    service: mcp-gateway
    
  - old: "localhost:11434"
    new: "ai-ollama.dev.local.heady.internal:11434"
    service: ollama
    
  - old: "0.0.0.0:3300"
    new: "manager.dev.local.heady.internal:3300"
    service: manager
    
  - old: "::1:3300"
    new: "manager.dev.local.heady.internal:3300"
    service: manager

# Environment-specific overrides
environments:
  dev:
    suffix: dev.local.heady.internal
    tls: false
    auth: basic
    
  staging:
    suffix: staging.heady.io
    tls: true
    auth: mtls
    
  prod:
    suffix: prod.heady.io
    tls: true
    auth: mtls+oauth
    
  local-offline:
    suffix: local.heady.internal
    tls: false
    auth: none
    localhost_fallback: true
